"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function genUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)})}function mkWorker(scriptStr){var blob=new Blob([scriptStr],{type:"application/javascript"}),uri=blobToURI(blob);return new Worker(uri)}function loadLocalFile(){var input=document.createElement("input");return input.type="file",input.click(),new Promise(function(resolve,reject){input.onchange=function(){resolve(input.files[0])}})}function readLocalFile(blob){var readAs=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"readAsText",reader=new FileReader;return reader[readAs](blob),new Promise(function(resolve,reject){reader.onloadend=function(){resolve(reader.result)}})}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();blobToURI=URL.createObjectURL;var Pathname=function(){function Pathname(input){_classCallCheck(this,Pathname),this.input=input,this.clean=this.cleanf(),this.chop=this.chopf(),this.name=this.namef(),this.basename=this.basenamef(),this.parent=this.parentf(),this.extentions=this.extentionsf(),this.segment=this.segmentf()}return _createClass(Pathname,[{key:"cleanf",value:function(){var clean=[],pathArray=this.input.match(/[^\/]+/g);for(var i in pathArray){var name=pathArray[i];"."===name||(".."===name?clean.pop():clean.push(name))}return"/"+clean.join("/")}},{key:"chopf",value:function(){var segments=this.clean.match(/[^\/]+/g);return null===segments?["/"]:segments}},{key:"namef",value:function(){return this.chop[this.chop.length-1]}},{key:"basenamef",value:function(){var name=this.name;if(""===name)return name;var base=name.match(/^[^\.]+/);return null!==base?base[0]:""}},{key:"parentf",value:function(){if("/"===this.name)return null;var parentLen=this.clean.length-this.name.length;return this.clean.slice(0,parentLen)}},{key:"extentionsf",value:function(){return this.name.match(/\.[^\.]+/g)}},{key:"segmentf",value:function(){var pathArray=this.chop,segments=[];if("/"===this.name)segments=["/"];else for(var i=0;i<=pathArray.length;i++){var matchPath=pathArray.slice(0,i);segments.push("/"+matchPath.join("/"))}return segments}}]),Pathname}(),Inode=function Inode(){var config=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Inode),this.links=0,Object.assign(this,config)},Disk=function(){function Disk(){_classCallCheck(this,Disk),this.uuid=genUUID(),this.inodes=[new Inode({links:1,id:0,type:"d",files:{".":0,"..":0}})]}return _createClass(Disk,[{key:"addInode",value:function(type){var name=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,parentInode=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(name.match("/"))return-1;var id=this.inodes.length;return this.inodes[id]=new Inode({links:1,type:type,id:id}),parentInode instanceof Inode&&"d"===parentInode.type&&(parentInode.files[name]=id),this.inodes[id]}},{key:"mkFile",value:function(name,parentInode){var inode=this.addInode("f",name,parentInode);return inode<0?-1:(inode.data="",inode)}},{key:"mkDir",value:function(name,parentInode){var inode=this.addInode("d",name,parentInode);return inode<0?-1:(inode.files={".":inode.id,"..":parentInode.id},inode)}},{key:"mkLink",value:function(name,parentInode,targetInode){return name.match("/")?-1:(parentInode.files[name]=targetInode.id,targetInode)}},{key:"mkSymLink",value:function(name,parentInode,targetPath){var inode=this.addInode("sl",name,parentInode);if(inode<0)return-1;var path=new Pathname(targetPath).clean;return inode.redirect=path,inode}}]),Disk}(),VFS=function(){function VFS(rootDisk){_classCallCheck(this,VFS),this.mounts={"/":rootDisk},this.opened={}}return _createClass(VFS,[{key:"mount",value:function(disk,mountPoint){return this.mounts[mountPoint]=disk}},{key:"unmount",value:function(mountPoint){return delete this.mounts[mountPoint]}},{key:"unmountByUUID",value:function(uuid){var mountPoints=Object.keys(box.fs.mounts);for(var i in mountPoints){var mountPoint=mountPoints[i];if(this.mounts[mountPoint].uuid===uuid)return delete this.mounts[mountPoint]}}},{key:"mountPoint",value:function mountPoint(path){var pathname=new Pathname(path),segments=pathname.segment,mounts=Object.keys(this.mounts),resolves=[];for(var i in mounts){var mount=new Pathname(mounts[i]).clean;for(var _i in segments)segments[_i]===mount&&resolves.push(mount)}var mountPoint=resolves.pop();return mountPoint}},{key:"resolveHard",value:function(path){var inode=0,trace=[inode],pathname=new Pathname(path),mountPoint=this.mountPoint(pathname.clean),disk=this.mounts[mountPoint],diskLocalPath=pathname.clean.substring(mountPoint.length);if(""===diskLocalPath)return disk.inodes[inode];var pathArray=new Pathname(diskLocalPath).chop;for(var i in pathArray){var name=pathArray[i],inodeObj=disk.inodes[inode];if(void 0===inodeObj.files)return-1;if(inode=inodeObj.files[name],void 0===inode)return-1;trace.push(inode)}return disk.inodes[trace.pop()]}},{key:"resolve",value:function(path){var redirectCount=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(redirectCount>=50)return-1;var inode=this.resolveHard(path);return inode<0?-1:"sl"===inode.type?(redirectCount++,this.resolve(inode.redirect,redirectCount)):inode}},{key:"rm",value:function(path){var pathname=new Pathname(path),parent=pathname.parent,parentInode=this.resolve(parent),name=pathname.name;return parentInode<0?-1:delete parentInode.files[name]}},{key:"mkPath",value:function(type,path){var target=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,pathname=new Pathname(path),parent=pathname.parent,parentInode=this.resolve(parent),name=pathname.name,mountPoint=this.mountPoint(pathname.clean),disk=this.mounts[mountPoint];if(parentInode<0)return-1;var addedInode=-1;if("f"===type)addedInode=disk.mkFile(name,parentInode);else if("d"===type)addedInode=disk.mkDir(name,parentInode);else if("l"===type&&null!==target){var targetInode=this.resolve(target);if(targetInode<0)return-1;addedInode=disk.mkLink(name,parentInode,targetInode)}else{if("sl"!==type||null===target)return-1;addedInode=disk.mkSymLink(name,parentInode,target)}return addedInode<0?-1:addedInode}},{key:"touch",value:function(path){return this.mkPath("f",path)}},{key:"mkdir",value:function(path){return this.mkPath("d",path)}},{key:"ln",value:function(path,targetPath){return this.mkPath("l",path,targetPath)}},{key:"lns",value:function(path,targetPath){return this.mkPath("sl",path,targetPath)}}]),VFS}(),FileDesc=function FileDesc(path){var fs=arguments.length>1&&void 0!==arguments[1]?arguments[1]:window.box.fs;_classCallCheck(this,FileDesc),this.path=path,this.inode=fs.resolve(this.path)},Process=function(){function Process(){var computer=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.box;_classCallCheck(this,Process),this.fs=computer.fs,this.fds=[]}return _createClass(Process,[{key:"open",value:function(path){var fd=new FileDesc(path,this.fs);return this.fds.push(fd),this.fds.length-1}},{key:"read",value:function(fdID){var fd=this.fds[fdID];return void 0!==fd.inode.data?fd.inode.data:-1}},{key:"write",value:function(fdID,data){var fd=this.fds[fdID];return void 0!==fd.inode.data?fd.inode.data=data:-1}}]),Process}(),Computer=function Computer(name){_classCallCheck(this,Computer),this.name=name,this.fs=new VFS(new Disk)};window.box=new Computer("fauxOS");